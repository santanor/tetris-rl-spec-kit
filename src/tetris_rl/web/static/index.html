<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tetris RL Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <header>
    <h1>Tetris RL</h1>
    <div class="header-controls inline">
      <button id="startBtn">Start</button>
      <div class="ctrl"><span>Episodes</span><input id="episodesInput" type="number" value="5" min="1" max="500"/></div>
  <div class="ctrl"><span>Broadcast</span><input id="broadcastEveryInput" type="number" value="1" min="1" max="500"/></div>
    </div>
  </header>
  <main>
    <!-- Board Panel -->
    <section class="panel board-panel">
      <div class="panel-title">Board</div>
      <div class="board-wrap vertical">
        <pre id="board"></pre>
        <div id="colorBoard" class="color-board" aria-label="Color Board" role="img"></div>
      </div>
    </section>
    <!-- Stats Panel -->
    <section class="panel stats-panel">
      <div class="panel-title">Stats</div>
      <div class="stats-grid">
        <div><span class="s-label">Episode</span><span id="statEpisode">-</span></div>
        <div><span class="s-label">Global</span><span id="statGlobalStep">-</span></div>
        <div><span class="s-label">Reward</span><span id="statReward">-</span></div>
        <div><span class="s-label">Loss</span><span id="statLoss">-</span></div>
        <div><span class="s-label">Epsilon</span><span id="statEpsilon">-</span></div>
        <div><span class="s-label">Lines</span><span id="statLines">-</span></div>
        <div><span class="s-label">ΔLines</span><span id="statLinesDelta">-</span></div>
      </div>
      <div class="heights-block">
        <div class="sub-title">Heights</div>
        <div id="heightsBar" class="heights-bar"></div>
        <div id="imbalanceInfo" class="heights-meta"></div>
      </div>
      <div class="recent-block">
        <div class="sub-title">Recent Episodes</div>
        <ul id="recentEpisodes" class="recent-episodes"></ul>
      </div>
    </section>
    <!-- Charts / Observability Panel -->
    <section class="panel charts-panel">
      <div class="panel-title">Observability</div>
      <div class="charts-grid">
        <div class="chart-card"><div class="chart-title">Episode Reward (last 200)</div><canvas id="rewardChart"></canvas></div>
        <div class="chart-card"><div class="chart-title">Loss (EMA + raw)</div><canvas id="lossChart"></canvas></div>
        <div class="chart-card"><div class="chart-title">Lines per Episode</div><canvas id="linesChart"></canvas></div>
  <div class="chart-card small"><div class="chart-title">Minimal Reward (latest)</div><canvas id="componentsChart"></canvas></div>
        <div class="chart-card small"><div class="chart-title">Action Distribution</div><canvas id="actionChart"></canvas></div>
        <div class="chart-card wide" id="networkCard">
          <div class="chart-title" style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;">
            <span>Policy Network (State → Q-values)</span>
            <div class="net-controls"><button type="button" id="freezeNetBtn" class="mini-btn">Freeze</button></div>
          </div>
          <canvas id="networkCanvas" width="760" height="400"></canvas>
          <div class="q-gradient"><span id="qMin">min</span><div class="bar"></div><span id="qMax">max</span></div>
          <div class="net-legend" id="netLegend">Input dims: — | Actions: — | Color = relative Q (min→max)</div>
        </div>
      </div>
    </section>
    <!-- Reward Config Panel -->
    <section class="panel config-panel">
      <div class="panel-title">Reward Config</div>
      <form id="rewardConfigForm" class="config-simple">
        <label>1 line <input name="line_reward_1" type="number" step="0.01"/></label>
        <label>2 lines <input name="line_reward_2" type="number" step="0.01"/></label>
        <label>3 lines <input name="line_reward_3" type="number" step="0.01"/></label>
        <label>4 lines <input name="line_reward_4" type="number" step="0.01"/></label>
        <label>Survival <input name="survival_reward" type="number" step="0.001"/></label>
        <label>Delta stable + <input name="delta_stable_reward" type="number" step="0.01"/></label>
        <label>Hole penalty/created <input name="hole_penalty_per" type="number" step="0.01"/></label>
        <label>Top-out <input name="top_out_penalty" type="number" step="0.1"/></label>
        <div class="config-actions"><button type="submit">Apply</button><span id="configStatus" class="status"></span></div>
      </form>
      <div class="mini-help">Rewards: lines (big), survival tick, delta-stable on lock (no skyline increase), per-hole penalty for newly created holes, and top-out penalty. Adjust carefully.</div>
    </section>
    <!-- Early Stopping Config Panel -->
    <section class="panel config-panel">
      <div class="panel-title">Early Stopping</div>
      <form id="earlyStopForm" class="config-simple">
        <label>Enable <input name="early_stop_enable" type="checkbox"/></label>
        <label>Metric
          <select name="early_stop_metric">
            <option value="avg_reward">avg_reward</option>
            <option value="avg_lines">avg_lines</option>
          </select>
        </label>
        <label>Window N <input name="early_stop_window" type="number" min="1" step="1"/></label>
        <label>Min delta <input name="early_stop_min_delta" type="number" step="0.01"/></label>
        <label>Patience <input name="early_stop_patience" type="number" min="1" step="1"/></label>
        <div class="config-actions"><button type="submit">Apply</button><span id="earlyStopStatus" class="status"></span></div>
      </form>
      <div class="mini-help">Stop if the rolling average of the chosen metric does not improve by at least Min delta for Patience windows (each window is the last N episodes). Defaults are conservative; tune for your training length.</div>
    </section>
    <!-- Training GPU / Performance Panel -->
    <section class="panel config-panel">
      <div class="panel-title">Training Performance</div>
      <form id="trainPerfForm" class="config-simple">
        <label>AMP (mixed precision) <input name="use_amp" type="checkbox"/></label>
        <label>Batch size <input name="batch_size" type="number" min="1" step="1"/></label>
        <label>Opt steps / env step <input name="opt_steps_per_env_step" type="number" min="1" step="1"/></label>
        <label>Grad clip norm <input name="grad_clip_norm" type="number" step="0.1"/></label>
        <label>Compile model (PyTorch 2) <input name="compile_model" type="checkbox"/></label>
        <label>Pin memory <input name="pin_memory" type="checkbox"/></label>
        <div class="config-actions"><button type="submit">Apply</button><span id="trainPerfStatus" class="status"></span></div>
      </form>
      <div class="mini-help">Increase optimizer steps per env step to keep the GPU busy. AMP speeds up compute on CUDA. Compile model may improve throughput on PyTorch 2.x. Use clipping for stability.</div>
    </section>
  </main>
  <div id="networkTooltip"></div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="/static/main.js"></script>
</body>
</html>
